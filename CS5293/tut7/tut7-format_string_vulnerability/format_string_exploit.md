# Hands-on Format String Exploit

## Set up Lab Environment

```bash
# install python3 (skip this step if you have installed conda)
# sudo apt install python3 python3-dev

# use bash or zsh as sh (skip this step if you use bash as the default shell)
# zsh --version
# sudo ln -sf /bin/zsh /bin/sh
# or 
# chsh -s $(which zsh)

# restart the terminal and check the shell version
# echo $SHELL

# turn off Address Space Layout Randomization (ASLR) (2 for default)
sudo sysctl -w kernel.randomize_va_space=0

# check the randomization status
sudo sysctl kernel.randomize_va_space

# compile the vulnerable program stack
gcc -Wall -g -m32 -z execstack -fno-stack-protector -o victim_32 victim.c

# change stack into a set-uid program if you want to get a root shell
sudo chown root victim_32 && sudo chmod 4755 victim_32

# test slack with an empty badfile
touch empty_badfile
./victim_32 < empty_badfile
```

## Task 1: Crash

```bash
./victim_32 < task1_badfile
```

## Task 2: Print

```bash
./victim_32 < task2_badfile
```

## Find the offset and the address of stack frame (ebp or rbp)

Use debugger **gdb** to get `&buffer` and `$ebp`(`$rbp` if 64-bit).

```bash
# enter gdb, use -n to close peda, use -q to remove copyright message
gdb -nh -q stack_32

# gdb commands
b unsafe_copy # insert a breakpoint in unsafe_copy()
r # run
n # !!! note: step inside unsafe_copy()
info locals # check local variables
p &target_str # address of target_str (buffer)
p $ebp # address of ebp
c # continue to run remaining code
q # quit
```

